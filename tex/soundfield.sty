\NeedsTeXFormat{LaTeX2e}[1994/06/01]
\ProvidesPackage{soundfield}

\RequirePackage{amsmath}  \RequirePackage{amssymb}  \RequirePackage{amsfonts}
\RequirePackage{accents}
\RequirePackage{pgf, pgffor}

\pgfkeys{/sf/.is family}

% helper function to create a key representing a variable length list including brackets and delimiter
% parameters:
%   optional parameters (keyvalue pairs): left bracket, right bracket, delimiter, modifier
%   keyname: name of key
%
% Examples:
% afterwards elements can be added via: \pgfkeys{sf, <keyname>={arg1,arg2,arg3}}
%
% all non-empty lists will be printed by calling: \pgfkeys{sf, print}
% all lists will be reset by calling: \pgfkeys{sf, reset}
\newcommand\sfnewlistkey[2][]{  %
  \pgfkeys{  %
    sf,  %
    #2/.style={ #2/enum/.list={##1} },  %  interprete 'argument = {1,2,3}' as list
    % initialize enum of valid elements
    #2/enum/.is choice,
    % 
    #2/current/.initial=\empty,  %
    #2/current/.code = {  %
      \edef\currentvalue{##1}
      \edef\listvalue{\pgfkeysvalueof{/sf/#2/current}}
      \ifx\currentvalue\empty\else
        \ifx\listvalue\empty\else
          \pgfkeys{sf, #2/current/.append=\pgfkeysvalueof{/sf/#2/delimiter} }
        \fi
        \pgfkeys{sf, #2/current/.append={##1}}
      \fi
    },
    #2/print/.code={  %
      \edef\listvalue{\pgfkeysvalueof{/sf/#2/current}}
      \ifx\listvalue\empty\else
        \pgfkeysvalueof{/sf/#2/modifier}
        {  %
        \pgfkeysvalueof{/sf/#2/brackets/left}
        \pgfkeysvalueof{/sf/#2/current}
        \pgfkeysvalueof{/sf/#2/brackets/right}
        }
%        \pgfkeys{ sf,  %
%          #2/current/.add={\pgfkeysvalueof{/sf/#2/brackets/left}}{\pgfkeysvalueof{/sf/#2/brackets/right}},
%          #2/current/.prefix=\pgfkeysvalueof{/sf/#2/modifier}
%        }
      \fi
%      \pgfkeysvalueof{/sf/#2/current}
    },
    % add list to print
    print/.append style={ #2/print  },  %
    % append initial values to reset function
    reset/.append style={ #2/current/.initial=\empty  }  %
  }
  
  \pgfkeys{sf,  %
    list/.cd, %
    left bracket/.style = {/sf/#2/brackets/left/.initial={##1}},  %
    right bracket/.style = {/sf/#2/brackets/right/.initial={##1}},  %
    delimiter/.style = {/sf/#2/delimiter/.initial={##1}},  %
    modifier/.style = {/sf/#2/modifier/.initial={##1}},   %
    % default values
    left bracket=,  %
    right bracket=,  %
    delimiter= {,},  %
    modifier=,  %
    % optional input
    #1  %
  }
}
% Define a possible choice for key
% \sfnewkeychoice{<keyname>}{<choicename>}{<value>}
\newcommand\sfnewkeychoice[3]{  %
  \pgfkeys{sf, #1/enum/#2/.style={#1/current=#3}}  %
}
% Link a choice for key to symbol
% \sflinkkeychoice{<keyname>}{<choicename>}{<symbol>}
\newcommand\sflinkkeychoice[3]{  %
  \pgfkeys{sf, #1/enum/#2/.style={#1/current=#3}}  %
}

% Define a new symbol
% \sfnewsymbol[list of <key-value-pairs>]{<symbolname>}{<value>}
\newcommand\sfnewsymbol[3][]{  %
  \pgfkeys{sf, symbol/new={#2}{#3}{#1} } %
}
% Extend existing symbols by additional parameters speficied by key-value-pairs
% \sfextendsymbol[list of <key-value-pairs>]{list of <symbol>}{<symbolsuffix>}
%
% Afterwards for each <symbol> specfied the following command is available:
% \sf<symbolname><symbolsuffix>
\newcommand\sfextendsymbol[3][]{  %
  \pgfkeys{sf,  %
    tmp/symbolname/.style={  %
      tmp/symbolsuffix/.style={symbol/extend={##1}{####1}{#1}},  %
      tmp/symbolsuffix/.list={#3}  %
    },  %
    tmp/symbolname/.list={#2}  %
  }  %
}

\newcommand{\sfprint}[1][]{  %
  \pgfkeys{sf, reset, #1, print, reset}
}

\newcommand\sfnewprefix[2]{  %
  \sfnewkeychoice{prefix}{#1}{#2}
}

%% INITIALIZATION  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Prefix
\pgfkeys{
  sf,  %
  prefix/.style = { prefix/enum=#1 },
  prefix/enum/.is choice,  %
  prefix/current/.initial=\empty
}

%% Reset and Print
\pgfkeys{  %
  sf,  %
  reset/.style={  %
    symbol/current/.initial=\empty,  %
    prefix/current/.initial=\empty,  %
  },  %
  print/.style={  %
    symbol/current/print  %
  },  %
}

%% Symbols
\pgfkeys{
  sf,  %
  symbol/.style = {symbol/enum=#1},
  symbol/enum/.is choice,  %
  symbol/new/.style n args={3}{  %
    symbol/newcommand={#1},  %
    symbol/enum/#1/.initial=#2,  %
    symbol/enum/#1/.style={symbol/current=\pgfkeysvalueof{/sf/symbol/enum/#1}, #3}  %
  },  %
  symbol/extend/.style n args={3}{  %
    symbol/newcommand={#1#2},  %
    symbol/enum/#1#2/.style={symbol/enum/#1, #3}
  }, %
  symbol/newcommand/.code= {  %
    \expandafter\newcommand\csname sf#1\endcsname[1][]{%
      \sfprint[symbol=#1, ##1]  %
    }  %
  },  %
  % current symbol for printing
  symbol/current/.initial=\empty,  %
  symbol/current/print/.code={  %
    \pgfkeysvalueof{/sf/prefix/current}  %
    {\pgfkeysvalueof{/sf/symbol/current}}  %
  }
}

%% SYMBOLS, SUBSCRIPTS, SUPERSCRIPTS, MODIFIERS  %%%%%%%%%%%%%%%%%

%%%% List of Modifiers %%%%

\sfnewmodifier{partial}{\frac{\partial}{\partial}}

%%%% List of Symbols %%%%
\sfnewprefix{vec}{\mathbf}
\sfnewprefix{alternative}{\uppercase}
%% Vectors %%
\sfnewsymbol[prefix=vec]{pos}{x}  % position vector
\sfnewsymbol[prefix=vec]{normal}{n}  % unit vector
%% Coordinates
\sfnewsymbol{sphr}{r}
\sfnewsymbol{sphphi}{\phi}
\sfnewsymbol{sphtheta}{\vartheta}
%% Sampling Distance
\sfnewsymbol{delta}{\Delta}

%% Time-Frequency Domain %%
\sfnewsymbol{omega}{\omega}
\sfnewsymbol{f}{f}
\sfnewsymbol{t}{t}

%% Spatio-Frequency Domain %%
\sfnewsymbol{wavenumber}{\frac{\omega}{c}}

%% Sound Field Synthesis %%
\sfnewsymbol{pressure}{P}  % sound pressure
\sfnewsymbol{virtualsource}{S}  % virtual sound field
\sfnewsymbol{driving}{D}  % driving function
\sfnewsymbol{greens}{G}  % Green's Function
\sfnewsymbol{hrtf}{H}  % head-related transfer function

\sfnewsymbol{select}{a}
\sfnewsymbol{window}{w}
\sfnewsymbol[subscript=twohalfD]{correct}{c}

%% Special Functions
\sfnewsymbol{sphharmonics}{Y}
\sfnewsymbol{sphbessel}{j}
\sfnewsymbol{sphhankel}{h}

%% Integrals
% differential operators
\sfnewprefix{differential}{\mathrm d}
\sfnewprefix{partial}{\partial}
\sfnewsymbol{laplace}{\Delta}
% areas and boundaries
\sfnewsymbol{set}{\Omega}
\sfextendsymbol[prefix=partial]{set}{boundary}

\sfnewsymbol{boundary}{\partial \Omega}
\sfnewsymbol{volume}{V}
\sfnewsymbol{area}{A}
% differentials
\sfextendsymbol[prefix=differential]{volume}{diff}
\sfextendsymbol[prefix=differential]{area}{diff}

%% Constants %%
\sfnewprefix{const}{\mathrm}
%
\sfnewsymbol[prefix=const]{euler}{e}
\sfnewsymbol[prefix=const]{im}{j}
\sfnewsymbol[prefix=const]{speedofsound}{c}

%%%% List of Transforms %%%%
%% Cartesian Coordinates
\sfnewprefix{pwd}{\tilde}  % plane wave decompostion
\sfextendsymbol[prefix=pwd]{normal, greens, driving, hrtf, virtualsource}{pwd}
%% Cylindrical Coordinates
\sfnewprefix{cht}{\accentset{\circ}}  % cylindrical harmonics transform
%% Spherical Coordinates
\sfnewprefix{sht}{\accentset{\bullet}}  % spherical harmonics transform

%% Time 
\sfnewprefix{time}{\lowercase}
\sfextendsymbol[prefix=time]{normal, greens, driving, hrtf, virtualsource}{time}

%%%% List of subscripts %%%%
\sfnewlistkey[modifier={_}]{subscript}

%% Source Types %%
\sfnewkeychoice{subscript}{pw}{\mathrm{pw}}
\sfnewkeychoice{subscript}{ps}{\mathrm{ps}}
\sfnewkeychoice{subscript}{fs}{\mathrm{fs}}
\sfnewkeychoice{subscript}{ls}{\mathrm{ls}}
% extensions of symbols
\sfextendsymbol[subscript=pw]{pos, normal, driving}{pw}
\sfextendsymbol[subscript=ps]{pos, normal, driving}{ps}
\sfextendsymbol[subscript=ls]{pos, normal, driving}{ls}
\sfextendsymbol[subscript=fs]{pos, normal, driving}{fs}

%% Reference Coordinates %%
\sfnewkeychoice{subscript}{ref}{\mathrm{ref}}
\sfextendsymbol[subscript=ref]{pos, sphr}{ref}

%% Errors
\sfnewkeychoice{subscript}{err}{\epsilon}
\sfextendsymbol[subscript=err]{pressure}{err}

%% Domains %%
\sfnewkeychoice{subscript}{virtual}{\mathrm{s}}
\sfnewkeychoice{subscript}{local}{l}
\sfnewkeychoice{subscript}{sec}{0}
\sfnewkeychoice{subscript}{wc}{\{\mathrm{0},l\}}
\sfnewkeychoice{subscript}{incoming}{\mathrm{in}}
\sfnewkeychoice{subscript}{scatter}{\mathrm{sc}}
\sfnewkeychoice{subscript}{homogeneous}{\mathrm{hom}}
\sfnewkeychoice{subscript}{inhomogeneous}{\mathrm{inh}}

% extensions of symbols
\sfextendsymbol[subscript=scatter]{pressure}{sc}
\sfextendsymbol[subscript=incoming]{pressure}{in}
\sfextendsymbol[subscript=homogeneous]{pressure}{hom}
\sfextendsymbol[subscript=inhomogeneous]{pressure}{inh}
\sfextendsymbol[subscript=sec]{pos, normal, sphr, sphphi, greens, select, 
driving, set, setboundary, area, volume, areadiff, volumediff, laplace}{sec}
\sfextendsymbol[subscript=local]{pos, normal, driving, select, set, setboundary, area, volume, areadiff, volumediff}{local}

%% HRTF %%
\sfnewkeychoice{subscript}{left}{\mathrm{L}}
\sfnewkeychoice{subscript}{right}{\mathrm{R}}

%% Dimensions %%
\sfnewkeychoice{subscript}{twoD}{\mathrm{2D}}
\sfnewkeychoice{subscript}{twohalfD}{\mathrm{2.5D}}
\sfnewkeychoice{subscript}{threeD}{\mathrm{3D}}
% extensions of symbols
\sfextendsymbol[subscript=twoD]{greens, driving}{twoD}
\sfextendsymbol[subscript=twohalfD]{pressure, driving}{twohalfD}
\sfextendsymbol[subscript=threeD]{greens, driving}{threeD}

%% Boundary Conditions
\sfnewkeychoice{subscript}{neumann}{\mathrm{N}}
\sfnewkeychoice{subscript}{dirichlet}{\mathrm{D}}
% extensions of symbols
\sfextendsymbol[subscript=neumann]{greens}{N}
\sfextendsymbol[subscript=dirichlet]{greens}{D}

%%%% List of superscripts %%%%
\sfnewlistkey[modifier={^}]{superscript}
%% pratical aspects for loudspeaker array %%
\sfnewkeychoice{superscript}{sampled}{\mathrm{S}}
\sfnewkeychoice{superscript}{truncated}{\mathrm{T}}
%% time reversal/phase conjugation
\sfnewkeychoice{superscript}{timereverse}{*}

%%%% MISC %%%%
\newcommand\sfgreensdipole[1][]{ %
    \frac{\sfgreens[prefix=partial,#1]}{\sfnormal[prefix=partial,#1]}
  }

